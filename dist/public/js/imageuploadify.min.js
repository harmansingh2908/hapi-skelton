"use strict";

;(function ($, window, document, undefined) {
  window.addEventListener("dragover", function (e) {
    e = e || event;e.preventDefault();
  }, false);window.addEventListener("drop", function (e) {
    e = e || event;e.preventDefault();
  }, false);var compareMimeType = function compareMimeType(mimeTypes, fileType, formatFile) {
    if (mimeTypes.length < 2 && mimeTypes[0] === "*") {
      return true;
    }
    for (var index = 1; index < mimeTypes.length; index += 3) {
      if (mimeTypes[index + 1] === "*" && fileType.search(new RegExp(mimeTypes[index])) != -1) {
        return true;
      } else if (mimeTypes[index + 1] && mimeTypes[index + 1] != "*" && fileType.search(new RegExp("\\*" + mimeTypes[index + 1] + "\\*")) != -1) {
        return true;
      } else if (mimeTypes[index + 1] && mimeTypes[index + 1] != "*" && fileType.search(new RegExp(mimeTypes[index + 1])) != -1) {
        return true;
      } else if (mimeTypes[index + 1] === "" && (fileType.search(new RegExp(mimeTypes[index])) != -1 || formatFile.search(new RegExp(mimeTypes[index])) != -1)) {
        return true;
      }
    }
    return false;
  };
  $.fn.imageuploadify = function (opts) {
    var settings = $.extend({}, $.fn.imageuploadify.defaults, opts);this.each(function () {
      var self = this;if (!$(self).attr("multiple")) {
        return;
      }
      var accept = $(self).attr("accept") ? $(self).attr("accept").replace(/\s/g, "").split(",") : null;var result = [];accept.forEach(function (item) {
        var regexp = void 0;if (item.search(/\//) != -1) {
          regexp = new RegExp("([A-Za-z-.]*)\/([A-Za-z-*.]*)", "g");
        } else {
          regexp = new RegExp("\.([A-Za-z-]*)()", "g");
        }
        var r = regexp.exec(item);result = result.concat(r);
      });var totalFiles = [];var counter = 0;var dragbox = $("<div class=\"imageuploadify \"><div class=\"imageuploadify-overlay\"></div><div class=\"imageuploadify-images-list\"><button type=\"button\"class=\"btn btn-default\"><i class=\"fa fa-plus\" aria-hidden=\"true\"></i>\n</button></div></div>");var overlay = dragbox.find(".imageuploadify-overlay");var uploadIcon = dragbox.find(".imageuploadify-overlay i");var imagesList = dragbox.find(".imageuploadify-images-list");var addIcon = dragbox.find(".imageuploadify-images-list i");var addMsg = dragbox.find(".imageuploadify-images-list span");var button = dragbox.find(".imageuploadify-images-list button");var retrieveFiles = function retrieveFiles(files) {
        for (var index = 0; index < files.length; ++index) {
          if (!accept || compareMimeType(result, files[index].type, /(?:\.([^.]+))?$/.exec(files[index].name)[1])) {
            var id = Math.random().toString(36).substr(2, 9);readingFile(id, files[index]);totalFiles.push({ id: id, file: files[index] });
          }
        }
      };
      var readingFile = function readingFile(id, file) {
        var fReader = new FileReader();var width = dragbox.width();var boxesNb = Math.floor(width / 100);var marginSize = Math.floor((width - boxesNb * 100) / (boxesNb + 1));var container1 = $("<div class='imageuploadify-container1'><button type='button'class='btn'><i class=\"fa fa-times\" aria-hidden=\"true\"></i></button><div class='imageuploadify-details'><span>" + file.name + "</span><span>" + file.type + "</span><span>" + file.size + "</span></div></div>");var details = container1.find(".imageuploadify-details");var deleteBtn = container1.find("button");container1.css("margin-left", marginSize + "px");details.hover(function () {
          $(this).css("opacity", "1");
        }).mouseleave(function () {
          $(this).css("opacity", "0");
        });if (file.type && file.type.search(/image/) != -1) {
          fReader.onloadend = function (e) {
            var image = $("<img>");image.attr("src", e.target.result);container1.append(image);imagesList.append(container1);imagesList.find(".imageuploadify-container1:nth-child(" + boxesNb + "n+4)").css("margin-left", marginSize + "px");imagesList.find(".imageuploadify-container1:nth-child(" + boxesNb + "n+3)").css("margin-right", marginSize + "px");
          };
        } else if (file.type) {
          var type = "<i class='fa fa-file'></i>";if (file.type.search(/audio/) != -1) {
            type = "<i class='fa fa-file-audio-o'></i>";
          } else if (file.type.search(/video/) != -1) {
            type = "<i class='fa fa-file-video-o'></i>";
          }
          fReader.onloadend = function (e) {
            var span = $("<span>" + type + "</span>");span.css("font-size", "5em");container1.append(span);imagesList.append(container1);imagesList.find(".imageuploadify-container1:nth-child(" + boxesNb + "n+4)").css("margin-left", marginSize + "px");imagesList.find(".imageuploadify-container1:nth-child(" + boxesNb + "n+3)").css("margin-right", marginSize + "px");
          };
        }
        deleteBtn.on("click", function () {
          $(this.parentElement).remove();for (var index = 0; totalFiles.length > index; ++index) {
            if (totalFiles[index].id === id) {
              totalFiles.splice(index, 1);break;
            }
          }
        });fReader.readAsDataURL(file);
      };var disableMouseEvents = function disableMouseEvents() {
        overlay.css("display", "flex");dragbox.css("border-color", "#3AA0FF");button.css("pointer-events", "none");addMsg.css("pointer-events", "none");addIcon.css("pointer-events", "none");imagesList.css("pointer-events", "none");
      };
      var enableMouseEvents = function enableMouseEvents() {
        overlay.css("display", "none");dragbox.css("border-color", "rgb(210, 210, 210)");button.css("pointer-events", "initial");addMsg.css("pointer-events", "initial");addIcon.css("pointer-events", "initial");imagesList.css("pointer-events", "initial");
      };
      button.mouseenter(function onMouseEnter(event) {
        button.css("background", "#3AA0FF").css("color", "white");
      }).mouseleave(function onMouseLeave() {
        button.css("background", "white").css("color", "#3AA0FF");
      });button.on("click", function onClick(event) {
        event.stopPropagation();event.preventDefault();$(self).click();
      });dragbox.on("dragenter", function onDragenter(event) {
        event.stopPropagation();event.preventDefault();counter++;disableMouseEvents();
      });dragbox.on("dragleave", function onDragLeave(event) {
        event.stopPropagation();event.preventDefault();counter--;if (counter === 0) {
          enableMouseEvents();
        }
      });dragbox.on("drop", function onDrop(event) {
        event.stopPropagation();event.preventDefault();enableMouseEvents();var files = event.originalEvent.dataTransfer.files;retrieveFiles(files);
      });$(window).bind("resize", function (e) {
        window.resizeEvt;$(window).resize(function () {
          clearTimeout(window.resizeEvt);window.resizeEvt = setTimeout(function () {
            var width = dragbox.width();var boxesNb = Math.floor(width / 100);var marginSize = Math.floor((width - boxesNb * 100) / (boxesNb + 1));var container1s = imagesList.find(".imageuploadify-container1");for (var index = 0; index < container1s.length; ++index) {
              $(container1s[index]).css("margin-right", "0px");$(container1s[index]).css("margin-left", marginSize + "px");
            }
            imagesList.find(".imageuploadify-container1:nth-child(" + boxesNb + "n+4)").css("margin-left", marginSize + "px");imagesList.find(".imageuploadify-container1:nth-child(" + boxesNb + "n+3)").css("margin-right", marginSize + "px");
          }, 500);
        });
      });
      $(self).on("change", function onChange() {
        var files = this.files;retrieveFiles(files);
      });$(self).closest("form").on("submit", function (event) {
        event.stopPropagation();event.preventDefault(event);var inputs = this.querySelectorAll("input, textarea, select, button");var formData = new FormData();for (var index = 0; index < inputs.length; ++index) {
          if (inputs[index].tagName === "SELECT" && inputs[index].hasAttribute("multiple")) {
            var options = inputs[index].options;for (var _i = 0; options.length > _i; ++_i) {
              if (options[_i].selected) {
                formData.append(inputs[index].getAttribute("name"), options[_i].value);
              }
            }
          } else if (!inputs[index].getAttribute("type") || inputs[index].getAttribute("type").toLowerCase() !== "checkbox" && inputs[index].getAttribute("type").toLowerCase() !== "radio" || inputs[index].checked) {
            formData.append(inputs[index].name, inputs[index].value);
          } else if ($(inputs[index]).getAttribute("type") != "file") {
            formData.append(inputs[index].name, inputs[index].value);
          }
        }
        for (var i = 0; i < totalFiles.length; i++) {
          formData.append(self.name, totalFiles[i].file);
        }
        var xhr = new XMLHttpRequest();xhr.onreadystatechange = function (e) {
          if (xhr.status == 200 && xhr.readyState === XMLHttpRequest.DONE) {
            window.location.replace(xhr.responseURL);
          }
        };
        xhr.open("POST", $(this).attr("action"), true);xhr.send(formData);return false;
      });$(self).hide();dragbox.insertAfter(this);
    });return this;
  };$.fn.imageuploadify.defaults = {};
})(jQuery, window, document);